<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Tienda | Cat√°logo</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>

  <!-- Header -->
  <header class="container header">
    <div>
      <h1>CAJA DE LAS SORPRESAS</h1>
      <h2>Cat√°logo de productos</h2>

      <form method="GET" action="/" class="topbar">
        <div class="searchbox">
          <input
            type="search"
            name="q"
            placeholder="Buscar producto..."
            value="<%= q || '' %>"
            aria-label="Buscar producto"
          />
          <button type="submit" aria-label="Buscar">üîç</button>
        </div>

  <!-- Bot√≥n para abrir panel de categor√≠as -->
      <div>
        <button type="button" class="cat-btn" id="openCats" >
          Categor√≠as ‚ò∞
        </button>
      </div>    


  <!-- Mantener categor√≠a actual en el form si ya ven√≠a seleccionada -->
      <input type="hidden" name="category" value="<%= selectedCategory || 'all' %>"/>
</form>

<!-- Overlay + Panel de categor√≠as -->
      <div class="overlay" id="overlay" hidden></div>

    <aside class="cat-panel" id="catPanel" aria-hidden="true">
      <div class="cat-panel__header">
        <strong>Categor√≠as</strong>
        <button type="button" class="cat-close" id="closeCats" aria-label="Cerrar">‚úï</button>
      </div>

      <nav class="cat-list">
        <!-- Todas -->
        <a
          class="cat-item <%= selectedCategory === 'all' ? 'active' : '' %>"
          href="/?<%= q ? ('q=' + encodeURIComponent(q) + '&') : '' %>category=all"
        >
          Todas
        </a>

        <% (categories || []).forEach(c => { %>
          <a
            class="cat-item <%= selectedCategory === c ? 'active' : '' %>"
            href="/?<%= q ? ('q=' + encodeURIComponent(q) + '&') : '' %>category=<%= encodeURIComponent(c) %>"
          >
            <%= c %>
          </a>
        <% }) %>
      </nav>
    </aside>

    <script>
      (function () {
        const openBtn = document.getElementById("openCats");
        const closeBtn = document.getElementById("closeCats");
        const panel = document.getElementById("catPanel");
        const overlay = document.getElementById("overlay");

        function openPanel() {
          panel.classList.add("open");
          overlay.hidden = false;
          overlay.classList.add("show");
          panel.setAttribute("aria-hidden", "false");
          openBtn.setAttribute("aria-expanded", "true");
          document.body.classList.add("no-scroll");
          document.body.classList.add("panel-open");
        }

        function closePanel() {
          panel.classList.remove("open");
          overlay.classList.remove("show");
          overlay.hidden = true;
          panel.setAttribute("aria-hidden", "true");
          openBtn.setAttribute("aria-expanded", "false");
          document.body.classList.remove("no-scroll");
          document.body.classList.remove("panel-open");
        }

        openBtn.addEventListener("click", openPanel);
        closeBtn.addEventListener("click", closePanel);
        overlay.addEventListener("click", closePanel);

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closePanel();
        });
      })();
    </script>

        <!-- Por si el navegador tiene JS desactivado -->
        <noscript>
          <button type="submit">Filtrar</button>
        </noscript>
      </form>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="container">
    <section class="grid">

      <% if (products.length === 0) { %>
        <p class="empty">No hay productos disponibles.</p>
      <% } %>

      <%
      const formatPrice = (value) => {
        return Number(value || 0).toLocaleString('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      };%>




      

      <% products.forEach(p => { %>
        <article class="p-card">
          <a class="p-link" href="/producto/<%= p.id %>">
            <div class="p-media">
              <img
                class="p-img"
                src="<%= p.image_url && p.image_url.length > 5 ? p.image_url : '/img/no-image.png' %>"
                alt="<%= p.name %>"
                loading="lazy"
                referrerpolicy="no-referrer"
                onerror="this.onerror=null; this.src='/img/no-image.png';"
              />
            </div>

            <div class="p-body">

              <h3 class="p-title"><%= p.name %></h3>

              <div class="p-prices">
                <% if (p.price_normal && Number(p.price_normal) > 0) { %>
                  <div class="p-normal">Precio normal Q<%= p.price_normal %></div>
                <% } %>

                <div class="p-price">
                  <span class="p-price-label">Precio</span>
                  <span class="p-price-price">Q <%= formatPrice(p.price) %></span>
                </div>
              </div>
            </div>
          </a>
        </article>        
      <% }) %>

    </section>
  </main>

</body>
</html>
