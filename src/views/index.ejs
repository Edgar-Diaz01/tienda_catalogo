<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Tienda | Catálogo</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>

  <!-- Header -->
  <header class="container header">
    <div>
      <h1>CAJA DE LAS SORPRESAS</h1>
      <h2>Catálogo de productos</h2>

      <!-- Filtro por categoría -->
      <form method="GET" action="/" class="filters">
        <label for="category">Categoría:</label>

        <select id="category" name="category" onchange="this.form.submit()">
          <option value="all" <%= selectedCategory === 'all' ? 'selected' : '' %>>
            Todas
          </option>

          <% (categories || []).forEach(c => { %>
            <option value="<%= c %>" <%= selectedCategory === c ? 'selected' : '' %>>
              <%= c %>
            </option>
          <% }) %>
        </select>

        <!-- Por si el navegador tiene JS desactivado -->
        <noscript>
          <button type="submit">Filtrar</button>
        </noscript>
      </form>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="container">
    <section class="grid">

      <% if (products.length === 0) { %>
        <p class="empty">No hay productos disponibles.</p>
      <% } %>

      <%
      const formatPrice = (value) => {
        return Number(value || 0).toLocaleString('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      };%>




      

      <% products.forEach(p => { %>
        <article class="p-card">
          <a class="p-link" href="/producto/<%= p.id %>">
            <div class="p-media">
              <span class="p-badge">¡Oferta!</span>

              <img
                class="p-img"
                src="<%= p.image_url && p.image_url.length > 5 ? p.image_url : '/img/no-image.png' %>"
                alt="<%= p.name %>"
                loading="lazy"
                referrerpolicy="no-referrer"
                onerror="this.onerror=null; this.src='/img/no-image.png';"
              />
            </div>

            <div class="p-body">

              <h3 class="p-title"><%= p.name %></h3>

              <div class="p-prices">
                <% if (p.price_normal && Number(p.price_normal) > 0) { %>
                  <div class="p-normal">Precio normal Q<%= p.price_normal %></div>
                <% } %>

                <div class="p-promo">
                  <span class="p-promo-label">Promo</span>
                  <span class="p-promo-price">Q <%= formatPrice(p.price) %></span>
                </div>
              </div>
            </div>
          </a>
        </article>        
      <% }) %>

    </section>
  </main>

</body>
</html>
